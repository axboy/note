# 迁移 RDS for MySQL 数据到本地 MySQL

### 步骤

- 前提条件说明

工作目录为/data/docker/mysql/，xtrabackup软件二进制包在此目录，下载的备份文件为/data/rds_backup_data.tar.gz

1. 切换路径，解压文件

```sh
mkdir -p /data/docker/mysql/rds
cd /data/docker/mysql

tar vizxf /data/rds_backup_data.tar.gz -C rds
```

2. 恢复数据文件

```sh
./percona-xtrabackup-2.3.10-Linux-x86_64/bin/innobackupex --defaults-file=./rds/backup-my.cnf --apply-log ./rds/
```

3. 修改配置文件

将 __./rds/backup-my.cnf__ 中的 __innodb_fast_checksum、innodb_page_size、innodb_log_block_size__ 注释掉，参考内容如下

```sh
cat rds/backup-my.cnf 
# This MySQL options file was generated by innobackupex.

# The MySQL server
[mysqld]
innodb_checksum_algorithm=innodb
innodb_log_checksum_algorithm=innodb
innodb_data_file_path=ibdata1:200M:autoextend
innodb_log_files_in_group=2
innodb_log_file_size=1048576000
#innodb_fast_checksum=false
#innodb_page_size=16384
#innodb_log_block_size=512
innodb_undo_directory=.
innodb_undo_tablespaces=0

rds_encrypt_data=false
innodb_encrypt_algorithm=aes_128_ecb
```

4. 临时创建一个mysql docker容器

创建临时容器的原因是本机没有装mysql

```sh
docker run -d --name tmp_mysql \
    -v `pwd`/rds:/rds \
    -e MYSQL_ROOT_PASSWORD=123456 \
    --privileged \
    mysql:5.6
```

5. 进入容器内重装数据库

```sh
docker exec -it tmp_mysql bash
mysql_install_db --user=root --datadir=/rds/
```

6. 关闭临时容器，创建新容器，设置密码

```sh
docker stop tmp_mysql
```

增加配置文件，免密码

```sh
vi conf/my.cnf
############# 内容如下
[mysqld]
skip-grant-tables
```

启动容器，设置密码

```sh
docker run -d --name mysql \
    -p 3306:3306 \
    -v `pwd`/rds:/var/lib/mysql \
    -v `pwd`/conf:/etc/mysql/conf.d \
    --privileged \
    --restart=always \
    mysql:5.6

docker exec -it mysql bash
mysql -u root -p
CREATE USER 'root'@'%' IDENTIFIED BY '123456';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
flush privileges;
```

关闭免密容器，移除相关配置，重启，然后开始使用吧

```sh
mv conf/my.cnf conf/my.cnf.bak
docker restart mysql
```

### 参考文档

- [阿里云文档中心](https://www.alibabacloud.com/help/zh/doc-detail/26212.htm)